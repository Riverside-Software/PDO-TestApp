 
 /*------------------------------------------------------------------------
    File        : Form1
    Purpose     : 
    Syntax      : 
    Description : 
    Author(s)   : mferrant
    Created     : Wed Jun 04 14:00:08 EDT 2008
    Notes       : 
  ----------------------------------------------------------------------*/

USING Progress.Lang.*.
USING Progress.Windows.Form.

USING Infragistics.Win.UltraWinTree.*.

USING WinTree.UltraTreeSorting.*.

CLASS WinTree.UltraTreeSorting.Form1 INHERITS Form   : 

	DEFINE PRIVATE VARIABLE components AS System.ComponentModel.IContainer.


	DEFINE PUBLIC VARIABLE TreeLevelSortDirectionComboBox AS System.Windows.Forms.ComboBox NO-UNDO.
	DEFINE PUBLIC VARIABLE TreeLevelSortByComboBox AS System.Windows.Forms.ComboBox NO-UNDO.
	DEFINE PUBLIC VARIABLE Label2 AS System.Windows.Forms.Label NO-UNDO.
	DEFINE PRIVATE VARIABLE ultraTree1 AS Infragistics.Win.UltraWinTree.UltraTree NO-UNDO.
	DEFINE PUBLIC VARIABLE Label1 AS System.Windows.Forms.Label NO-UNDO.
	DEFINE PUBLIC VARIABLE RefreshSortButton AS System.Windows.Forms.Button NO-UNDO.
	DEFINE PUBLIC VARIABLE GroupBox1 AS System.Windows.Forms.GroupBox NO-UNDO.

    /*Drive letter to read from. This is just for sample purposes. No data on the 
	  drive will ever be changed by this program.*/
    DEFINE PRIVATE VARIABLE DriveLetter AS CHARACTER NO-UNDO INITIAL "C:\\".

    /*Number of levels to drill down to on the hard drive*/
    DEFINE PRIVATE VARIABLE DrillDownLevels AS INTEGER INITIAL 3.

	/*Define a new custom SortComparer for the Tree*/
	DEFINE PRIVATE PROPERTY TreeLevelSortComparer AS TreeSortComparer NO-UNDO GET. SET.

	CONSTRUCTOR PUBLIC Form1():
		SUPER().
		InitializeComponent().
		ASSIGN TreeLevelSortComparer = new TreeSortComparer().
	END CONSTRUCTOR.

	DESTRUCTOR PUBLIC Form1 ( ):
		IF VALID-OBJECT(components) THEN DO:
			CAST(components, System.IDisposable):Dispose().
		END.
	END DESTRUCTOR.

	METHOD PRIVATE VOID InitializeComponent ( ):

/* 		NOTE: The following method is generated by the OpenEdge Advanced GUI Visual Designer.

		We strongly suggest that the contents of this method only be modified using the
		Visual Designer to avoid any incompatible modifications.

		Modifying the contents of this method using a code editor will invalidate any support for this file. */

		THIS-OBJECT:TreeLevelSortDirectionComboBox = NEW System.Windows.Forms.ComboBox().
		THIS-OBJECT:TreeLevelSortByComboBox = NEW System.Windows.Forms.ComboBox().
		THIS-OBJECT:Label2 = NEW System.Windows.Forms.Label().
		THIS-OBJECT:ultraTree1 = NEW Infragistics.Win.UltraWinTree.UltraTree().
		THIS-OBJECT:Label1 = NEW System.Windows.Forms.Label().
		THIS-OBJECT:RefreshSortButton = NEW System.Windows.Forms.Button().
		THIS-OBJECT:GroupBox1 = NEW System.Windows.Forms.GroupBox().
		CAST(THIS-OBJECT:ultraTree1, System.ComponentModel.ISupportInitialize):BeginInit().
		THIS-OBJECT:GroupBox1:SuspendLayout().
		THIS-OBJECT:SuspendLayout().
		/*  */
		/* TreeLevelSortDirectionComboBox */
		/*  */
		THIS-OBJECT:TreeLevelSortDirectionComboBox:Location = NEW System.Drawing.Point(8, 72).
		THIS-OBJECT:TreeLevelSortDirectionComboBox:Name = "TreeLevelSortDirectionComboBox".
		THIS-OBJECT:TreeLevelSortDirectionComboBox:Size = NEW System.Drawing.Size(224, 21).
		THIS-OBJECT:TreeLevelSortDirectionComboBox:TabIndex = 3.
		THIS-OBJECT:TreeLevelSortDirectionComboBox:SelectedIndexChanged:SUBSCRIBE(THIS-OBJECT:TreeLevelSortDirectionComboBox_SelectedIndexChanged).
		/*  */
		/* TreeLevelSortByComboBox */
		/*  */
		@VisualDesigner.FormMember (NeedsInitialize="false", InitializeArray="true").
		DEFINE VARIABLE arrayvar0 AS System.Array NO-UNDO.
		arrayvar0 = System.Array:CreateInstance(Progress.Util.TypeHelper:GetType("System.Object"), 3).
		arrayvar0:SetValue("ByText", 0).
		arrayvar0:SetValue("ByKey", 1).
		arrayvar0:SetValue("ByCheckBox", 2).
		THIS-OBJECT:TreeLevelSortByComboBox:Items:AddRange(CAST(arrayvar0, "System.Object[]")).
		THIS-OBJECT:TreeLevelSortByComboBox:Location = NEW System.Drawing.Point(8, 32).
		THIS-OBJECT:TreeLevelSortByComboBox:Name = "TreeLevelSortByComboBox".
		THIS-OBJECT:TreeLevelSortByComboBox:Size = NEW System.Drawing.Size(224, 21).
		THIS-OBJECT:TreeLevelSortByComboBox:TabIndex = 1.
		THIS-OBJECT:TreeLevelSortByComboBox:SelectedIndexChanged:SUBSCRIBE(THIS-OBJECT:TreeLevelSortByComboBox_SelectedIndexChanged).
		/*  */
		/* Label2 */
		/*  */
		THIS-OBJECT:Label2:Location = NEW System.Drawing.Point(8, 56).
		THIS-OBJECT:Label2:Name = "Label2".
		THIS-OBJECT:Label2:Size = NEW System.Drawing.Size(136, 16).
		THIS-OBJECT:Label2:TabIndex = 2.
		THIS-OBJECT:Label2:Text = "Sort direction:".
		THIS-OBJECT:Label2:UseCompatibleTextRendering = TRUE.
		/*  */
		/* ultraTree1 */
		/*  */
		THIS-OBJECT:ultraTree1:Anchor = CAST(Progress.Util.EnumHelper:Or(Progress.Util.EnumHelper:Or(Progress.Util.EnumHelper:Or(System.Windows.Forms.AnchorStyles:Top, System.Windows.Forms.AnchorStyles:Bottom), System.Windows.Forms.AnchorStyles:Left), System.Windows.Forms.AnchorStyles:Right), System.Windows.Forms.AnchorStyles).
		THIS-OBJECT:ultraTree1:Location = NEW System.Drawing.Point(12, 12).
		THIS-OBJECT:ultraTree1:Name = "ultraTree1".
		THIS-OBJECT:ultraTree1:Size = NEW System.Drawing.Size(198, 329).
		THIS-OBJECT:ultraTree1:TabIndex = 8.
		/*  */
		/* Label1 */
		/*  */
		THIS-OBJECT:Label1:Location = NEW System.Drawing.Point(8, 16).
		THIS-OBJECT:Label1:Name = "Label1".
		THIS-OBJECT:Label1:Size = NEW System.Drawing.Size(136, 16).
		THIS-OBJECT:Label1:TabIndex = 0.
		THIS-OBJECT:Label1:Text = "Sort by:".
		THIS-OBJECT:Label1:UseCompatibleTextRendering = TRUE.
		/*  */
		/* RefreshSortButton */
		/*  */
		THIS-OBJECT:RefreshSortButton:Anchor = CAST(Progress.Util.EnumHelper:Or(System.Windows.Forms.AnchorStyles:Top, System.Windows.Forms.AnchorStyles:Right), System.Windows.Forms.AnchorStyles).
		THIS-OBJECT:RefreshSortButton:Location = NEW System.Drawing.Point(266, 164).
		THIS-OBJECT:RefreshSortButton:Name = "RefreshSortButton".
		THIS-OBJECT:RefreshSortButton:Size = NEW System.Drawing.Size(160, 24).
		THIS-OBJECT:RefreshSortButton:TabIndex = 7.
		THIS-OBJECT:RefreshSortButton:Text = "Refresh Sorting".
		THIS-OBJECT:RefreshSortButton:UseCompatibleTextRendering = TRUE.
		THIS-OBJECT:RefreshSortButton:Click:SUBSCRIBE(THIS-OBJECT:RefreshSortButton_Click).
		/*  */
		/* GroupBox1 */
		/*  */
		THIS-OBJECT:GroupBox1:Anchor = CAST(Progress.Util.EnumHelper:Or(System.Windows.Forms.AnchorStyles:Top, System.Windows.Forms.AnchorStyles:Right), System.Windows.Forms.AnchorStyles).
		THIS-OBJECT:GroupBox1:Controls:Add(THIS-OBJECT:TreeLevelSortDirectionComboBox).
		THIS-OBJECT:GroupBox1:Controls:Add(THIS-OBJECT:Label2).
		THIS-OBJECT:GroupBox1:Controls:Add(THIS-OBJECT:TreeLevelSortByComboBox).
		THIS-OBJECT:GroupBox1:Controls:Add(THIS-OBJECT:Label1).
		THIS-OBJECT:GroupBox1:Location = NEW System.Drawing.Point(218, 20).
		THIS-OBJECT:GroupBox1:Name = "GroupBox1".
		THIS-OBJECT:GroupBox1:Size = NEW System.Drawing.Size(248, 104).
		THIS-OBJECT:GroupBox1:TabIndex = 6.
		THIS-OBJECT:GroupBox1:TabStop = FALSE.
		THIS-OBJECT:GroupBox1:Text = "Tree-level Override".
		THIS-OBJECT:GroupBox1:UseCompatibleTextRendering = TRUE.
		/*  */
		/* Form1 */
		/*  */
		THIS-OBJECT:ClientSize = NEW System.Drawing.Size(660, 377).
		THIS-OBJECT:Controls:Add(THIS-OBJECT:ultraTree1).
		THIS-OBJECT:Controls:Add(THIS-OBJECT:RefreshSortButton).
		THIS-OBJECT:Controls:Add(THIS-OBJECT:GroupBox1).
		THIS-OBJECT:Name = "Form1".
		THIS-OBJECT:Text = "UltraTreeSorting".
		THIS-OBJECT:Load:SUBSCRIBE(THIS-OBJECT:Form1_Load).
		CAST(THIS-OBJECT:ultraTree1, System.ComponentModel.ISupportInitialize):EndInit().
		THIS-OBJECT:GroupBox1:ResumeLayout(FALSE).
		THIS-OBJECT:ResumeLayout(FALSE).

	END METHOD.

	/*------------------------------------------------------------------------------
			Purpose:
			Notes:
	------------------------------------------------------------------------------*/
	@VisualDesigner.
	METHOD PRIVATE VOID Form1_Load( INPUT sender AS System.Object, INPUT e AS System.EventArgs ):
	    /*Set the SortComparer of the tree to the customer sort comparer we created
          Note that his is the tree override level comparer, so it will affect the entire tree*/
        ultraTree1:OVERRIDE:SortComparer = TreeLevelSortComparer.

        /*Set the whole tree to show checkboxes*/
        ultraTree1:OVERRIDE:NodeStyle = Infragistics.Win.UltraWinTree.NodeStyle:CheckBox.

        /*Don't want level 0 to have a checkbox, so set the 
          NodeStyle to stand just for level 0*/
        ultraTree1:NodeLevelOverrides[0]:NodeStyle = Infragistics.Win.UltraWinTree.NodeStyle:Standard.

	    /*Populate the tree with data*/
		LoadHardDriveData().

		/*Populate the Combo Boxes used to sort*/
		PopulateComboBoxes().
	END METHOD.

	/*------------------------------------------------------------------------------
			Purpose:
			Notes:
	------------------------------------------------------------------------------*/
	METHOD PRIVATE VOID LoadHardDriveData(  ):
        LoadSubFolders(new System.IO.DirectoryInfo(DriveLetter), ?).
	END METHOD.

	/*------------------------------------------------------------------------------
			Purpose:
			Notes:
	------------------------------------------------------------------------------*/
	METHOD PRIVATE VOID LoadSubFolders(INPUT ParentFolder AS System.IO.DirectoryInfo,
	                                   INPUT ParentNode   AS UltraTreeNode):

	    DEFINE VARIABLE ParentFolderName AS CHARACTER NO-UNDO.
	    DEFINE VARIABLE ParentFolderKey  AS CHARACTER NO-UNDO.

        DEFINE VARIABLE directories AS System.Array.
        DEFINE VARIABLE currentDirectory AS INTEGER NO-UNDO.
        DEFINE VARIABLE totalDirectories AS INTEGER NO-UNDO.
        DEFINE VARIABLE directoryObject AS  System.IO.DirectoryInfo NO-UNDO.

	    ASSIGN ParentFolderName = ParentFolder:Name
			   ParentFolderKey  = ParentFolder:FullName.

		IF ParentNode = ? THEN
		    ParentNode = ultraTree1:Nodes:Add(ParentFolderKey, ParentFolderName).
		ELSE DO:
		    ParentNode = ParentNode:Nodes:Add(ParentFolderKey, ParentFolderName).
			IF ParentNode:Level >= DrillDownLevels THEN RETURN.
		END.

	    ASSIGN directories = CAST(ParentFolder:GetDirectories(), "System.IO.DirectoryInfo[]")
	           totalDirectories = directories:LENGTH - 1 NO-ERROR.

        /*Some restricted directories like "C:\System VOlume Information" rise a "System.UnauthorizedAccesException" exception.
          So we ignore those directories here.*/
	    IF ERROR-STATUS:ERROR THEN NEXT.

        REPEAT currentDirectory = 0 TO totalDirectories:
			ASSIGN directoryObject = CAST(directories:GetValue(currentDirectory),System.IO.DirectoryInfo).

			LoadSubFolders(directoryObject, ParentNode).
	    END.
	END METHOD.

	/*------------------------------------------------------------------------------
			Purpose:
			Notes:
	------------------------------------------------------------------------------*/
	METHOD PRIVATE VOID PopulateComboBoxes(  ):
		DEFINE VARIABLE SortDirectionArray AS System.Array NO-UNDO.
		DEFINE VARIABLE comboElement       AS INTEGER      NO-UNDO.
        DEFINE VARIABLE lowerBound         AS INTEGER      NO-UNDO.
        DEFINE VARIABLE upperBound         AS INTEGER      NO-UNDO.

		ASSIGN SortDirectionArray = System.Enum:GetValues(Progress.Util.TypeHelper:GetType("Infragistics.Win.UltraWinTree.SortType"))
		       lowerBound         = SortDirectionArray:GetLowerBound(0)
		       upperBound         = SortDirectionArray:GetUpperBound(0).

		REPEAT comboElement = lowerBound TO upperBound:
			TreeLevelSortDirectionComboBox:Items:Add(CAST(SortDirectionArray:GetValue(comboElement), Infragistics.Win.UltraWinTree.SortType)).
		END.

		ASSIGN TreeLevelSortDirectionComboBox:SelectedIndex = 0
		       TreeLevelSortByComboBox:SelectedIndex        = 0.
	END METHOD.

	/*------------------------------------------------------------------------------
			Purpose:
			Notes:
	------------------------------------------------------------------------------*/
	@VisualDesigner.
	METHOD PRIVATE VOID TreeLevelSortByComboBox_SelectedIndexChanged( INPUT sender AS System.Object, INPUT e AS System.EventArgs ):
        TreeLevelSortComparer:SortType = TreeLevelSortByComboBox:SelectedIndex + 1.
		/*The tree has no way to know that SortType has changed, 
		  (since it's a property of the customer sort comparer
		   class. So we need to tell the tree to re-sort.*/ 
		ultraTree1:RefreshSort().
	END METHOD.

	/*------------------------------------------------------------------------------
			Purpose:
			Notes:
	------------------------------------------------------------------------------*/
	@VisualDesigner.
	METHOD PRIVATE VOID TreeLevelSortDirectionComboBox_SelectedIndexChanged( INPUT sender AS System.Object, INPUT e AS System.EventArgs ):
        /*The tree knows that the sort property changed and so 
		  it automatically refreshes the sorting. We do not 
		  need to call RefreshSort here.*/ 
		ultraTree1:OVERRIDE:Sort = CAST(TreeLevelSortDirectionComboBox:SelectedItem, Infragistics.Win.UltraWinTree.SortType).
        
	END METHOD.

	/*------------------------------------------------------------------------------
			Purpose:
			Notes:
	------------------------------------------------------------------------------*/
	@VisualDesigner.
	METHOD PRIVATE VOID RefreshSortButton_Click( INPUT sender AS System.Object, INPUT e AS System.EventArgs ):
        ultraTree1:RefreshSort().
	END METHOD.
END CLASS.